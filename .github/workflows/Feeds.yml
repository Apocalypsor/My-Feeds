name: Feeds

on:
  workflow_dispatch:

  schedule:
    - cron: 0 * * * *

jobs:
  feeds:
    name: Generate Feeds
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v1
      with:
        python-version: '3.8'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Generate DMZJ
      run: |
        mkdir dist
        python rss.py dmzj
        [ -d "dist/assets" ] && mv dist/assets ./tmp
    - name: Push RSS
      uses: JamesIves/github-pages-deploy-action@3.6.1
      with:
        GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
        BRANCH: feeds
        FOLDER: dist
        CLEAN: true
    - name: Push assets
      env:
        GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
      run: |
        git clone https://github.com/Apocalypsor/Storage /tmp/Storage
        [ -d "/tmp/Storage/feed" ] && rm -rf /tmp/Storage/feed/* || mkdir /tmp/Storage/feed
        mv tmp/* /tmp/Storage/feed && cd /tmp/Storage
        git config --global user.name "GitHub Action"
        git config --global user.email github-action@users.noreply.github.com
        git add . && git commit -am 'Update feed assets'
        git push https://Apocalypsor:$GITHUB_TOKEN@github.com/Apocalypsor/Storage